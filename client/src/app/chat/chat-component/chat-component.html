<div class="container-fluid">
  <div class="row vh-100">

    <!-- USERS LIST -->
    <div class="col-3 border-end p-3">
      <h5>Users</h5>

      @if (users.length === 0) {
        <p class="text-muted">No users found</p>
      }

      <ul class="list-group mt-3">
        @for (user of users; track user._id) {
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
            (click)="selectUser(user)"
            [class.active]="selectedUser?._id === user._id"
            style="cursor: pointer;"
          >
            {{ user.username }}
            <span
              class="rounded-circle"
              [class.bg-success]="user.online"
              [class.bg-secondary]="!user.online"
              style="width: 10px; height: 10px; display: inline-block;"
            ></span>
          </li>
        }
      </ul>
    </div>

    <!-- CHAT AREA -->
    <div class="col-9 d-flex flex-column">

      <!-- MESSAGES -->
      <div class="chat-body">

        <div
          class="chat-messages"
          #scrollContainer
          (scroll)="onScroll()"
        >

          @if (!selectedUser) {
            <p class="text-muted">Select a user to start chatting</p>
          }

          @for (msg of messages; track msg._id) {
            <div
              class="d-flex mb-2"
              [class.justify-content-end]="msg.senderId === currentUserId"
              [class.justify-content-start]="msg.senderId !== currentUserId"
            >

              <div
                class="message-bubble position-relative p-2 rounded shadow-sm"
                [ngClass]="{
                  'bg-primary text-white': msg.senderId === currentUserId,
                  'bg-light text-dark': msg.senderId !== currentUserId
                }"
              >

                <!-- MESSAGE ACTIONS -->
                @if (msg.senderId === currentUserId) {
                  <div class="message-actions">
                    <button
                      type="button"
                      class="btn btn-sm btn-light"
                      (click)="toggleMenu(msg._id)"
                    >
                      ⋮
                    </button>

                    @if (openMenuId === msg._id) {
                      <div class="message-menu">
                        <button
                          class="dropdown-item"
                          (click)="startEdit(msg)"
                        >
                          Edit
                        </button>
                        <button
                          class="dropdown-item text-danger"
                          (click)="deleteMsg(msg)"
                        >
                          Delete
                        </button>
                      </div>
                    }
                  </div>
                }

                <!-- EDIT MODE -->
                @if (editingMessageId === msg._id) {
                  <input
                    class="form-control form-control-sm mb-1"
                    [(ngModel)]="editedContent"
                  />
                  <div class="text-end">
                    <button
                      class="btn btn-sm btn-success me-1"
                      (click)="saveEdit(msg)"
                    >
                      Save
                    </button>
                    <button
                      class="btn btn-sm btn-secondary"
                      (click)="cancelEdit()"
                    >
                      Cancel
                    </button>
                  </div>
                }
                @else {
                  <div>{{ msg.content }}</div>

                  @if (msg.isEdited) {
                    <small class="text-white">(edited)</small>
                  }
                }

                <!-- TIME -->
                <div class="text-end small opacity-75 mt-1">
                  {{ formatTime(msg.createdAt) }}
                </div>

                <!-- STATUS DOTS -->
                @if (msg.senderId === currentUserId) {
                  <div class="text-end small mt-1">
                    @if (!msg.delivered) {
                      <span class="dot sent"></span>
                    }
                    @else if (msg.delivered && !msg.read) {
                      <span class="dot delivered"></span>
                      <span class="dot delivered"></span>
                    }
                    @else if (msg.read) {
                      <span class="dot read"></span>
                      <span class="dot read"></span>
                    }
                  </div>
                }

              </div>
            </div>
          }

        </div>

        <!-- NEW MESSAGE BUTTON -->
        @if (showNewMessageBtn) {
          <button
            class="btn btn-sm btn-secondary new-msg-btn"
            (click)="scrollToBottom(true)"
          >
            New messages ↓
          </button>
        }

      </div>

      <!-- INPUT -->
      @if (selectedUser) {
        <div class="p-3 border-top chat-input">

          @if (isSelectedUserTyping()) {
            <div class="text-muted small mb-1">
              {{ selectedUser.username }} is typing...
            </div>
          }

          <div class="d-flex">
            <input
              class="form-control me-2"
              [(ngModel)]="newMessage"
              placeholder="Type a message"
              (input)="onTypingInput()"
              (keyup.enter)="sendMessage()"
            />

            <button
              class="btn btn-primary"
              (click)="sendMessage()"
              [disabled]="!newMessage || newMessage.trim().length === 0"
            >
              Send
            </button>
          </div>

        </div>
      }

    </div>
  </div>
</div>
