<div class="container-fluid">
  <div class="row vh-100">

    <!-- USERS LIST -->
    <div class="col-3 border-end p-3">
      <h5>Users</h5>

      @if (users.length === 0) {
        <p class="text-muted">No users found</p>
      }

      <ul class="list-group mt-3">
        @for (user of users; track user._id) {
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
            (click)="selectUser(user)"
            [class.active]="selectedUser?._id === user._id"
            style="cursor: pointer;"
          >
            {{ user.username }}
            <span
              class="rounded-circle"
              [class.bg-success]="user.online"
              [class.bg-secondary]="!user.online"
              style="width: 10px; height: 10px; display: inline-block;"
            ></span>
          </li>
        }
      </ul>
    </div>

    <!-- CHAT AREA -->
    <div class="col-9 d-flex flex-column">

      <!-- MESSAGES -->
      <div class="flex-grow-1 overflow-auto p-3 position-relative" #scrollContainer (scroll)="onScroll()">

        @if (!selectedUser) {
          <p class="text-muted">Select a user to start chatting</p>
        }

        @for (msg of messages; track msg._id) {
          <div
            class="mb-2 d-flex"
            [class.justify-content-end]="msg.senderId === currentUserId"
            [class.justify-content-start]="msg.senderId !== currentUserId"
          >
            <div
              class="p-2"
              [ngClass]="{
                'bg-primary message-me': msg.senderId === currentUserId,
                'bg-secondary message-other': msg.senderId !== currentUserId
              }"
            >
              <div class="text-white">
                {{ msg.content }}
              </div>

              <div class="text-end text-light small mt-1" style="opacity: 0.8;">
                {{ formatTime(msg.createdAt) }}
              </div>

              @if (msg.senderId === currentUserId) {
                <div class="text-end small mt-1 message-status">
                  @if (!msg.delivered) {
                    <span class="dot sent"></span>
                  } @else if (msg.delivered && !msg.read) {
                    <span class="dot delivered"></span>
                    <span class="dot delivered"></span>
                  } @else if (msg.read) {
                    <span class="dot read"></span>
                    <span class="dot read"></span>
                  }
                </div>
              }
            </div>
          </div>
        }

        @if (showNewMessageBtn) {
          <button class="btn btn-sm btn-secondary new-msg-btn" (click)="scrollToBottom(true)">
            New messages â†“
          </button>
        }

      </div>

      <!-- INPUT -->
      @if (selectedUser) {
        <div class="p-3 border-top">

          @if (isSelectedUserTyping()) {
            <div class="text-muted small mb-1">
              {{ selectedUser.username }} is typing...
            </div>
          }

          <div class="d-flex">
            <input
              class="form-control me-2"
              [(ngModel)]="newMessage"
              placeholder="Type a message"
              (input)="onTypingInput()"
              (keyup.enter)="sendMessage()"
            />
            <button
              class="btn btn-primary"
              (click)="sendMessage()"
              [disabled]="!newMessage || newMessage.trim().length === 0"
            >
              Send
            </button>
          </div>

        </div>
      }

    </div>
  </div>
</div>
